<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="QC Inspect">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%23667eea' width='100' height='100'/%3E%3Ctext y='70' x='50' text-anchor='middle' font-size='60' fill='white'%3E‚úì%3C/text%3E%3C/svg%3E">
    <title>Quality Inspection App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .settings-icon {
            position: absolute;
            top: 30px;
            right: 30px;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s;
        }

        .settings-icon:hover {
            opacity: 1;
        }

        .content {
            padding: 30px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        input[type="text"],
        input[type="number"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: border 0.3s ease;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }

        .schedule-summary {
            background: #f9fafb;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #667eea;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .progress-bar {
            background: #e5e7eb;
            height: 8px;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.3s ease;
        }

        .check-item {
            background: #f9fafb;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #e5e7eb;
        }

        .check-item.completed {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .check-id {
            font-weight: 700;
            color: #667eea;
            font-size: 16px;
        }

        .check-spec {
            color: #666;
            font-size: 14px;
            margin: 8px 0;
            line-height: 1.5;
        }

        .result-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px;
            margin: 15px 0;
        }

        .result-btn {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .result-btn.pass {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .result-btn.fail {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        .fail-section {
            display: none;
            margin-top: 15px;
        }

        .fail-section.active {
            display: block;
        }

        .photo-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .checkbox-item:hover {
            border-color: #667eea;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
        }

        .checkbox-item.checked {
            border-color: #667eea;
            background: #ede9fe;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #333;
        }

        .close-modal {
            float: right;
            font-size: 28px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
        }

        .close-modal:hover {
            color: #333;
        }

        .batch-progress {
            background: #ede9fe;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #667eea;
        }

        .batch-progress h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .history-item {
            background: #f9fafb;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }

        .history-item.complete {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .history-title {
            font-weight: 700;
            font-size: 16px;
            color: #333;
        }

        .history-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-complete {
            background: #d1fae5;
            color: #065f46;
        }

        .status-in-progress {
            background: #fef3c7;
            color: #92400e;
        }

        .history-details {
            font-size: 14px;
            color: #666;
            line-height: 1.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="settings-icon" onclick="showSettingsModal()">‚öôÔ∏è</div>
            <h1>Quality Inspection</h1>
            <p>Form No: CMU-FO-03 | Rev.No: 00</p>
        </div>

        <div class="content">
            <!-- Screen 1: Start -->
            <div class="screen active" id="screen-start">
                <div id="not-configured-warning" class="alert alert-warning" style="display: none;">
                    <h3>‚ö†Ô∏è Setup Required</h3>
                    <p>This app is not configured yet. Please contact your administrator.</p>
                </div>
                <button class="btn btn-primary" onclick="startInspection()">Start Inspection</button>
                <button class="btn btn-secondary" onclick="showDownloadControlSheet()">üì• Download Control Sheet</button>
                <button class="btn btn-secondary" onclick="viewHistory()">üìã View History</button>
            </div>

            <!-- Screen 1.4: Download Control Sheet -->
            <div class="screen" id="screen-download-control">
                <h2 style="margin-bottom: 20px;">üì• Download Control Sheet</h2>
                
                <div class="alert alert-info">
                    <p style="margin-bottom: 10px;">Enter a schedule number to download its quality control sheet as PDF.</p>
                    <p style="font-size: 13px; color: #1e40af; margin: 0;">
                        The PDF will include all stations inspected, checkboxes for each sample (with ‚úó for failed), and signature sections.
                    </p>
                </div>

                <div class="form-group">
                    <label>Schedule Number *</label>
                    <input type="text" id="download-schedule-no" placeholder="e.g., ABC-1000" style="font-size: 18px; padding: 15px;">
                </div>

                <button class="btn btn-primary" onclick="downloadSchedulePDF()">
                    üì• Generate & Download PDF
                </button>
                
                <button class="btn btn-secondary" onclick="goToStart()">
                    ‚Üê Back to Home
                </button>
                
                <div id="download-status" style="margin-top: 20px;"></div>
            </div>

            <!-- Screen 1.5: History -->
            <div class="screen" id="screen-history">
                <h2 style="margin-bottom: 20px;">Inspection History</h2>
                
                <div class="form-group">
                    <label>Filter by Schedule Number (Optional)</label>
                    <input type="text" id="history-filter" placeholder="Enter schedule number" onkeyup="filterHistory()">
                </div>

                <div id="history-loading" class="alert alert-info" style="display: none;">
                    Loading history...
                </div>

                <div id="history-empty" class="alert alert-warning" style="display: none;">
                    No inspection history found.
                </div>

                <div id="history-container"></div>

                <button class="btn btn-secondary" onclick="goToStart()">‚Üê Back to Home</button>
            </div>

            <!-- Screen 2: Initial Data Entry -->
            <div class="screen" id="screen-initial-data">
                <h2 style="margin-bottom: 20px;">Inspection Setup</h2>
                
                <div class="form-group">
                    <label>Part Number *</label>
                    <input type="text" id="part-no" required>
                </div>

                <div class="form-group">
                    <label>Schedule Number *</label>
                    <input type="text" id="schedule-no" required onchange="checkExistingSchedule()">
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">Same schedule can go through multiple stations</p>
                </div>

                <div id="existing-schedule-alert" style="display: none;"></div>

                <div class="form-group">
                    <label>Batch Quantity *</label>
                    <input type="number" id="batch-qty" min="1" required onchange="updateSampleSize()">
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">Total quantity in this batch</p>
                </div>

                <div class="form-group">
                    <label>Inspection Level (Optional - ISO 2859-1)</label>
                    <select id="inspection-level" onchange="updateSampleSize()">
                        <option value="">No Level Selected (Manual sampling)</option>
                        <option value="I">Level I - Reduced Inspection (Smaller sample)</option>
                        <option value="II" selected>Level II - Normal Inspection (Standard sample)</option>
                        <option value="III">Level III - Tightened Inspection (Larger sample)</option>
                    </select>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">Suggests sample size per check. You can inspect more if needed.</p>
                </div>

                <div id="sample-size-display" style="display: none;" class="alert alert-info">
                    <h4 style="margin-bottom: 10px;">üìä Sample Size (ISO 2859-1) - PER STATION</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div>
                            <strong>Batch Size:</strong>
                            <div id="display-batch-size" style="font-size: 18px; color: #1e40af;">-</div>
                        </div>
                        <div>
                            <strong>Sample/Station:</strong>
                            <div id="display-sample-size" style="font-size: 18px; color: #059669; font-weight: 700;">-</div>
                        </div>
                        <div>
                            <strong>Code Letter:</strong>
                            <div id="display-code-letter" style="font-size: 18px; color: #1e40af; font-weight: 700;">-</div>
                        </div>
                    </div>
                    <div style="padding: 10px; background: #fef3c7; border-radius: 6px; border: 1px solid #f59e0b;">
                        <p style="font-size: 12px; color: #92400e; margin: 0;">
                            <strong>üí° Note:</strong> This sample size applies to <strong>THIS STATION ONLY</strong>. Each station needs this many samples checked.
                        </p>
                    </div>
                </div>

                <div class="form-group">
                    <label>Station *</label>
                    <select id="station" onchange="updateStationChecks(); checkExistingSchedule();">
                        <option value="">Select Station</option>
                        <option value="INNER CUTTING">INNER CUTTING</option>
                        <option value="OUTER CUTTING">OUTER CUTTING</option>
                        <option value="SLEEVE CUTTING">SLEEVE CUTTING</option>
                        <option value="GLUING">GLUING</option>
                        <option value="HEAT EMBORSING">HEAT EMBORSING</option>
                        <option value="SWAGING">SWAGING</option>
                        <option value="ASSEMBLY">ASSEMBLY</option>
                        <option value="MANUAL BUMPING">MANUAL BUMPING</option>
                        <option value="DIE CASTING">DIE CASTING</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Substation (Optional)</label>
                    <input type="text" id="substation">
                </div>

                <div class="form-group">
                    <label>Select Check Codes (Multiple allowed) *</label>
                    <div id="check-codes" class="checkbox-group"></div>
                </div>

                <div class="form-group">
                    <label>Operator Name (Optional)</label>
                    <input type="text" id="operator-name">
                </div>

                <div class="form-group">
                    <label>Inspector Name *</label>
                    <input type="text" id="inspector-name" required>
                </div>

                <button class="btn btn-primary" onclick="proceedToInspection()">Continue to Quality Check</button>
                <button class="btn btn-secondary" onclick="goToStart()">Cancel</button>
            </div>

            <!-- Screen 3: Quality Check -->
            <div class="screen" id="screen-quality-check">
                <div class="batch-progress" id="batch-progress-info"></div>
                
                <h2 style="margin-bottom: 10px;">Quality Check</h2>
                
                <div style="background: #fef3c7; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #f59e0b;">
                    <h4 style="color: #92400e; margin-bottom: 10px;">üì¶ Items to Inspect Today</h4>
                    <div style="display: flex; gap: 20px; align-items: center;">
                        <div style="flex: 1;">
                            <label style="margin-bottom: 5px; display: block; font-weight: 600;">Quantity to Check:</label>
                            <input type="number" id="batch-check-qty" min="1" placeholder="Enter quantity" style="width: 100%; padding: 12px; border: 2px solid #f59e0b; border-radius: 8px; font-size: 16px;" onchange="updateBatchCheckQty()">
                            <p style="font-size: 12px; color: #92400e; margin-top: 5px;" id="suggested-sample-text"></p>
                        </div>
                        <div style="flex: 1;">
                            <label style="margin-bottom: 5px; display: block; font-weight: 600;">Remaining in Batch:</label>
                            <div style="font-size: 24px; color: #059669; font-weight: 700;" id="remaining-display">-</div>
                        </div>
                    </div>
                    <p style="font-size: 12px; color: #92400e; margin-top: 10px; border-top: 1px solid #fbbf24; padding-top: 10px;">
                        <strong>Note:</strong> All selected checks will be performed on the <strong>same items</strong>.
                    </p>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
                <p style="text-align: center; color: #666; margin-bottom: 20px;" id="progress-text">0 of 0 completed</p>

                <div id="checks-container"></div>

                <button class="btn btn-success" onclick="submitInspection()" id="submit-btn" style="display: none;">Submit Inspection</button>
                <button class="btn btn-secondary" onclick="goBackToEdit()">‚Üê Back to Edit Details</button>
            </div>

            <!-- Screen 4: Success -->
            <div class="screen" id="screen-success">
                <div class="alert alert-success" id="success-alert">
                    <h3 style="margin-bottom: 10px;">‚úì Inspection Completed!</h3>
                    <p id="success-message"></p>
                    <div id="submission-status" style="margin-top: 15px; padding: 12px; border-radius: 8px; font-weight: 600;"></div>
                </div>

                <div id="inspection-summary" class="schedule-summary"></div>

                <div class="alert alert-info" style="margin-top: 20px;">
                    <h4 style="margin-bottom: 15px;">üìã Download Control Sheet (PDF)</h4>
                    
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #3b82f6; margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Enter Schedule Number:</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="pdf-schedule-no" placeholder="e.g., ABC-1000" style="flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                            <button onclick="downloadControlSheetPDF()" class="btn btn-primary" style="margin: 0; white-space: nowrap;">
                                üì• Download PDF
                            </button>
                        </div>
                        <p style="font-size: 12px; color: #666; margin-top: 8px; margin-bottom: 0;">
                            üí° Leave blank to download <strong id="current-schedule-display"></strong>
                        </p>
                    </div>
                    
                    <div style="font-size: 12px; color: #1e40af; background: #dbeafe; padding: 12px; border-radius: 6px;">
                        <strong>üìÑ What's included in the PDF:</strong><br>
                        ‚Ä¢ All stations inspected for this schedule<br>
                        ‚Ä¢ Individual check results (Pass/Fail) per check<br>
                        ‚Ä¢ 32 checkboxes per station to tick off<br>
                        ‚Ä¢ Signature section for Inspector, Supervisor, QC Manager
                    </div>
                </div>

                <button class="btn btn-primary" onclick="startNewInspection()">Start New Inspection</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeSettingsModal()">&times;</span>
            <div class="modal-header">‚öôÔ∏è Admin Settings</div>
            
            <div class="form-group">
                <label>Admin Password</label>
                <input type="password" id="admin-password" placeholder="Enter admin password">
            </div>

            <div id="settings-content" style="display: none;">
                <div class="alert alert-success" style="margin-bottom: 20px;">
                    <p>‚úì Password correct. You can now configure the app.</p>
                </div>

                <div class="form-group">
                    <label>Google Sheets Web App URL</label>
                    <input type="text" id="sheet-url-input" placeholder="https://script.google.com/macros/s/...">
                </div>

                <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
            </div>

            <button class="btn btn-primary" onclick="checkPassword()" id="check-password-btn">Unlock Settings</button>
        </div>
    </div>

    <script>
        const ADMIN_PASSWORD = 'admin123'; // CHANGE THIS!

        // ISO 2859-1 Sample Size Code Letters (General Inspection Level II)
        const iso2859SampleSizes = {
            // ISO 2859-1 Sample Size Table
            // Level I (S-1) - Reduced inspection
            // Level II (S-2) - Normal inspection (General Inspection Level II)
            // Level III (S-3) - Tightened inspection
            levelI: [
                { min: 2, max: 8, letter: 'A', sampleSize: 2 },
                { min: 9, max: 15, letter: 'A', sampleSize: 2 },
                { min: 16, max: 25, letter: 'A', sampleSize: 2 },
                { min: 26, max: 50, letter: 'B', sampleSize: 3 },
                { min: 51, max: 90, letter: 'B', sampleSize: 3 },
                { min: 91, max: 150, letter: 'C', sampleSize: 5 },
                { min: 151, max: 280, letter: 'D', sampleSize: 8 },
                { min: 281, max: 500, letter: 'E', sampleSize: 13 },
                { min: 501, max: 1200, letter: 'F', sampleSize: 20 },
                { min: 1201, max: 3200, letter: 'G', sampleSize: 32 },
                { min: 3201, max: 10000, letter: 'H', sampleSize: 50 },
                { min: 10001, max: 35000, letter: 'J', sampleSize: 80 },
                { min: 35001, max: 150000, letter: 'K', sampleSize: 125 },
                { min: 150001, max: 500000, letter: 'L', sampleSize: 200 },
                { min: 500001, max: Infinity, letter: 'M', sampleSize: 315 }
            ],
            levelII: [
                { min: 2, max: 8, letter: 'A', sampleSize: 2 },
                { min: 9, max: 15, letter: 'A', sampleSize: 2 },
                { min: 16, max: 25, letter: 'B', sampleSize: 3 },
                { min: 26, max: 50, letter: 'C', sampleSize: 5 },
                { min: 51, max: 90, letter: 'C', sampleSize: 5 },
                { min: 91, max: 150, letter: 'D', sampleSize: 8 },
                { min: 151, max: 280, letter: 'E', sampleSize: 13 },
                { min: 281, max: 500, letter: 'F', sampleSize: 20 },
                { min: 501, max: 1200, letter: 'G', sampleSize: 32 },
                { min: 1201, max: 3200, letter: 'H', sampleSize: 50 },
                { min: 3201, max: 10000, letter: 'J', sampleSize: 80 },
                { min: 10001, max: 35000, letter: 'K', sampleSize: 125 },
                { min: 35001, max: 150000, letter: 'L', sampleSize: 200 },
                { min: 150001, max: 500000, letter: 'M', sampleSize: 315 },
                { min: 500001, max: Infinity, letter: 'N', sampleSize: 500 }
            ],
            levelIII: [
                { min: 2, max: 8, letter: 'B', sampleSize: 3 },
                { min: 9, max: 15, letter: 'B', sampleSize: 3 },
                { min: 16, max: 25, letter: 'C', sampleSize: 5 },
                { min: 26, max: 50, letter: 'D', sampleSize: 8 },
                { min: 51, max: 90, letter: 'E', sampleSize: 13 },
                { min: 91, max: 150, letter: 'F', sampleSize: 20 },
                { min: 151, max: 280, letter: 'G', sampleSize: 32 },
                { min: 281, max: 500, letter: 'H', sampleSize: 50 },
                { min: 501, max: 1200, letter: 'J', sampleSize: 80 },
                { min: 1201, max: 3200, letter: 'K', sampleSize: 125 },
                { min: 3201, max: 10000, letter: 'L', sampleSize: 200 },
                { min: 10001, max: 35000, letter: 'M', sampleSize: 315 },
                { min: 35001, max: 150000, letter: 'N', sampleSize: 500 },
                { min: 150001, max: 500000, letter: 'P', sampleSize: 800 },
                { min: 500001, max: Infinity, letter: 'Q', sampleSize: 1250 }
            ]
        };

        function calculateSampleSize(batchSize, level = 'II') {
            let ranges;
            if (level === 'I') {
                ranges = iso2859SampleSizes.levelI;
            } else if (level === 'III') {
                ranges = iso2859SampleSizes.levelIII;
            } else {
                ranges = iso2859SampleSizes.levelII; // Default
            }
            
            for (let range of ranges) {
                if (batchSize >= range.min && batchSize <= range.max) {
                    return {
                        sampleSize: range.sampleSize,
                        letter: range.letter,
                        batchSize: batchSize,
                        level: level
                    };
                }
            }
            return { sampleSize: 0, letter: 'N/A', batchSize: batchSize, level: level };
        }

        const stationChecks = {
            "INNER CUTTING": [
                {id: "CMU/IC/001", check: "(R) Inner Wire Rope Cutting", spec: "Correct wire rope,without sharp edges & Actual length mention as per the Document"},
                {id: "CMU/IC/002", check: "(M) Inner Wire Rope Bumping", spec: "Properly Bumping"}
            ],
            "OUTER CUTTING": [
                {id: "CMU/OC/001", check: "(R) Outer Casing Cutting", spec: "Correct outer casing,&Actual length mention as per the Document without Damage"}
            ],
            "SLEEVE CUTTING": [
                {id: "CMU/SC/001", check: "(R) PVC Sleeve Cutting", spec: "Correct Sleeve,required length,mention as per the Document"}
            ],
            "GLUING": [
                {id: "CMU/GL/001", check: "(R) PVC Sleeve Pasting", spec: "Properly pasted with correct measurement mention as per the Process Document"}
            ],
            "HEAT EMBORSING": [
                {id: "CMU/HE/001", check: "(R) Print batch code according to month", spec: "Properly print part number,year & Date on PVC sleeve (using laser printer or Heat emborsing Machines)"}
            ],
            "SWAGING": [
                {id: "CMU/SW/001", check: "(R) END fitting Fixing", spec: "Fitted Required end fitting mention as per the process Document without Damage,Defect or Deformations."},
                {id: "CMU/SW/002", check: "(R) END fitting Swaging", spec: "END fitting are properly crimped without any damage,defect or deformations mention as per the process Document."}
            ],
            "ASSEMBLY": [
                {id: "CMU/AB/001", check: "(R) Assembling cable", spec: "Insert inner cable & parts Without Damage,Defect or Deformation mention as per the process Document"},
                {id: "CMU/AB/002", check: "(C) Free Length Cutting", spec: "Cutting Specified Specifications mention as per the Process Document & Cutting cable assembly straight without any bends."}
            ],
            "MANUAL BUMPING": [
                {id: "CMU/MB/001", check: "(M) Bumping the Cable", spec: "Bumping On required Side,Cable without Damage."}
            ],
            "DIE CASTING": [
                {id: "CMU/DC/001", check: "(C) Die casting the cable", spec: "Die Cast without damage,defect or deformation & using correct die type mention as per in the process Document."},
                {id: "CMU/DC/002", check: "(R) Free travel Length verification", spec: "Recommended free travel length with tolerance mention as per the process Document."}
            ]
        };

        let currentSchedule = {
            scheduleNo: '',
            partNo: '',
            batchQty: 0,
            sampleSize: 0,
            sampleCodeLetter: '',
            inspectionLevel: '',
            station: '',
            substation: '',
            operatorName: '',
            inspectorName: '',
            selectedChecks: [],
            existingData: null,
            checksCompleted: 0,
            totalChecksNeeded: 0
        };

        let currentInspection = {
            checkResults: []
        };

        let lastClickedButton = {};

        window.onload = function() {
            checkConfiguration();
        };

        function updateSampleSize() {
            const batchQty = parseInt(document.getElementById('batch-qty').value) || 0;
            const level = document.getElementById('inspection-level').value || 'II';
            const displayDiv = document.getElementById('sample-size-display');
            
            if (batchQty > 0 && level) {
                const result = calculateSampleSize(batchQty, level);
                
                document.getElementById('display-batch-size').textContent = batchQty.toLocaleString();
                document.getElementById('display-sample-size').textContent = result.sampleSize.toLocaleString();
                document.getElementById('display-code-letter').textContent = result.letter;
                
                displayDiv.style.display = 'block';
                
                // Store sample size and level for later use
                currentSchedule.sampleSize = result.sampleSize;
                currentSchedule.sampleCodeLetter = result.letter;
                currentSchedule.inspectionLevel = level;
            } else {
                displayDiv.style.display = 'none';
                currentSchedule.sampleSize = 0;
                currentSchedule.inspectionLevel = '';
            }
        }

        function checkConfiguration() {
            const url = localStorage.getItem('googleSheetsUrl');
            const warning = document.getElementById('not-configured-warning');
            if (!url) {
                warning.style.display = 'block';
            } else {
                warning.style.display = 'none';
            }
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function startInspection() {
            const url = localStorage.getItem('googleSheetsUrl');
            if (!url) {
                alert('This app is not configured. Please contact your administrator.');
                return;
            }
            showScreen('screen-initial-data');
        }

        function goToStart() {
            // Reset form
            document.getElementById('part-no').value = '';
            document.getElementById('schedule-no').value = '';
            document.getElementById('batch-qty').value = '';
            document.getElementById('station').value = '';
            document.getElementById('substation').value = '';
            document.getElementById('operator-name').value = '';
            document.getElementById('inspector-name').value = '';
            document.getElementById('check-codes').innerHTML = '';
            document.getElementById('existing-schedule-alert').style.display = 'none';
            
            currentSchedule = {
                scheduleNo: '',
                partNo: '',
                batchQty: 0,
                station: '',
                substation: '',
                operatorName: '',
                inspectorName: '',
                selectedChecks: [],
                existingData: null,
                checksCompleted: 0,
                totalChecksNeeded: 0
            };
            
            showScreen('screen-start');
        }

        function goBack() {
            showScreen('screen-initial-data');
        }

        function goBackToEdit() {
            if (confirm('Going back will clear your current progress. Are you sure?')) {
                showScreen('screen-initial-data');
            }
        }

        async function viewHistory() {
            const url = localStorage.getItem('googleSheetsUrl');
            if (!url) {
                alert('This app is not configured. Please contact your administrator.');
                return;
            }

            showScreen('screen-history');
            document.getElementById('history-loading').style.display = 'block';
            document.getElementById('history-empty').style.display = 'none';
            document.getElementById('history-container').innerHTML = '';

            try {
                const queryUrl = `${url}?action=getHistory`;
                const response = await fetch(queryUrl);
                const data = await response.json();

                document.getElementById('history-loading').style.display = 'none';

                if (data.schedules && data.schedules.length > 0) {
                    displayHistory(data.schedules);
                } else {
                    document.getElementById('history-empty').style.display = 'block';
                }
            } catch (error) {
                console.log('History fetch error:', error);
                document.getElementById('history-loading').style.display = 'none';
                document.getElementById('history-empty').style.display = 'block';
            }
        }

        let allHistory = [];

        function displayHistory(schedules) {
            allHistory = schedules;
            const container = document.getElementById('history-container');
            container.innerHTML = '';

            schedules.forEach(schedule => {
                const hasStations = schedule.stationProgress && schedule.stationProgress.length > 0;
                const completedCount = schedule.stationProgress ? schedule.stationProgress.filter(s => s.status === 'Complete').length : 0;
                const totalStations = schedule.stationProgress ? schedule.stationProgress.length : 0;

                const itemDiv = document.createElement('div');
                itemDiv.className = 'history-item';
                
                let stationHTML = '';
                if (hasStations) {
                    stationHTML = '<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;"><strong>Station Progress:</strong><div style="margin-top: 10px;">';
                    schedule.stationProgress.forEach(station => {
                        const isComplete = station.status === 'Complete';
                        const percent = station.sampleSize > 0 ? ((station.samplesInspected / station.sampleSize) * 100).toFixed(0) : 0;
                        stationHTML += `
                            <div style="background: ${isComplete ? '#f0fdf4' : '#fef3c7'}; padding: 10px; border-radius: 8px; margin-bottom: 8px; border: 2px solid ${isComplete ? '#10b981' : '#f59e0b'};">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <strong>${station.station}</strong>
                                    <span style="font-size: 12px; padding: 2px 8px; border-radius: 10px; background: ${isComplete ? '#10b981' : '#f59e0b'}; color: white;">${station.status}</span>
                                </div>
                                <div style="font-size: 13px; color: #666; margin-top: 5px;">${station.samplesInspected} / ${station.sampleSize} samples (${percent}%)</div>
                                <div style="background: #e5e7eb; height: 6px; border-radius: 10px; margin-top: 8px; overflow: hidden;">
                                    <div style="background: ${isComplete ? '#10b981' : '#667eea'}; height: 100%; width: ${percent}%;"></div>
                                </div>
                            </div>
                        `;
                    });
                    stationHTML += '</div></div>';
                }
                
                itemDiv.innerHTML = `
                    <div class="history-header">
                        <div class="history-title">Schedule: ${schedule.scheduleNo}</div>
                        <span class="history-status status-in-progress">
                            ${completedCount}/${totalStations} Stations
                        </span>
                    </div>
                    <div class="history-details">
                        <div><strong>Part No:</strong> ${schedule.partNo}</div>
                        <div><strong>Batch Qty:</strong> ${schedule.batchQty.toLocaleString()}</div>
                        ${schedule.completedStations ? `<div><strong>‚úì Completed:</strong> ${schedule.completedStations}</div>` : ''}
                        <div><strong>Last Station:</strong> ${schedule.lastStationChecked}</div>
                        <div><strong>Last Updated:</strong> ${new Date(schedule.lastUpdated).toLocaleString()}</div>
                        <div><strong>Last Inspector:</strong> ${schedule.lastInspector}</div>
                        ${stationHTML}
                    </div>
                `;
                container.appendChild(itemDiv);
            });
        }

        function filterHistory() {
            const filterText = document.getElementById('history-filter').value.trim().toLowerCase();
            
            if (!filterText) {
                displayHistory(allHistory);
                return;
            }

            const filtered = allHistory.filter(schedule => {
                const scheduleStr = String(schedule.scheduleNo || '').toLowerCase();
                const partStr = String(schedule.partNo || '').toLowerCase();
                return scheduleStr.includes(filterText) || partStr.includes(filterText);
            });

            if (filtered.length > 0) {
                displayHistory(filtered);
                document.getElementById('history-empty').style.display = 'none';
            } else {
                document.getElementById('history-container').innerHTML = '';
                document.getElementById('history-empty').style.display = 'block';
                document.getElementById('history-empty').textContent = 'No matching schedules found for "' + filterText + '"';
            }
        }

        function updateStationChecks() {
            const station = document.getElementById('station').value;
            const checkCodesDiv = document.getElementById('check-codes');
            checkCodesDiv.innerHTML = '';

            if (station && stationChecks[station]) {
                stationChecks[station].forEach(check => {
                    const div = document.createElement('div');
                    div.className = 'checkbox-item';
                    div.innerHTML = `
                        <input type="checkbox" id="check-${check.id}" value="${check.id}">
                        <label for="check-${check.id}" style="margin: 0; cursor: pointer;">
                            <strong>${check.id}</strong> - ${check.check}
                        </label>
                    `;
                    div.onclick = function(e) {
                        if (e.target.tagName !== 'INPUT') {
                            const checkbox = div.querySelector('input');
                            checkbox.checked = !checkbox.checked;
                        }
                        div.classList.toggle('checked', div.querySelector('input').checked);
                    };
                    checkCodesDiv.appendChild(div);
                });
            }
        }

        async function checkExistingSchedule() {
            const scheduleNo = document.getElementById('schedule-no').value.trim();
            const partNo = document.getElementById('part-no').value.trim();
            const station = document.getElementById('station').value;
            const alertDiv = document.getElementById('existing-schedule-alert');
            
            if (!scheduleNo || !partNo || !station) {
                alertDiv.style.display = 'none';
                return;
            }

            const sheetUrl = localStorage.getItem('googleSheetsUrl');
            if (!sheetUrl) return;

            try {
                // Query for existing schedule at this station
                const queryUrl = `${sheetUrl}?action=lookup&scheduleNo=${encodeURIComponent(scheduleNo)}&partNo=${encodeURIComponent(partNo)}&station=${encodeURIComponent(station)}`;
                const response = await fetch(queryUrl);
                const data = await response.json();

                if (data.exists) {
                    currentSchedule.existingData = data;
                    currentSchedule.checksCompleted = data.samplesInspected || 0;
                    currentSchedule.totalChecksNeeded = data.sampleSize || data.batchQty;
                    currentSchedule.sampleSize = data.sampleSize || 0;
                    currentSchedule.inspectionLevel = data.inspectionLevel || '';

                    alertDiv.className = 'alert alert-info';
                    alertDiv.style.display = 'block';
                    alertDiv.innerHTML = `
                        <h4 style="margin-bottom: 10px;">üìã Station Progress Found!</h4>
                        <p><strong>Station:</strong> ${data.station}</p>
                        <p><strong>Part No:</strong> ${data.partNo}</p>
                        <p><strong>Sample Size (this station):</strong> ${data.sampleSize}</p>
                        <p><strong>Samples Inspected:</strong> ${data.samplesInspected} / ${data.sampleSize}</p>
                        <p><strong>Remaining:</strong> ${data.remainingSamples}</p>
                        <p style="margin-top: 10px; color: #1e40af; font-weight: 600;">‚úì Continue inspection at this station!</p>
                    `;

                    // Auto-fill batch qty if not already filled
                    const batchQtyInput = document.getElementById('batch-qty');
                    if (!batchQtyInput.value && data.batchQty) {
                        batchQtyInput.value = data.batchQty;
                        batchQtyInput.readOnly = true;
                    }
                    
                    // Pre-fill inspection level
                    if (data.inspectionLevel) {
                        document.getElementById('inspection-level').value = data.inspectionLevel;
                    }
                    
                    // Update sample size display
                    updateSampleSize();
                } else {
                    // Check if schedule exists at all (different station)
                    await checkScheduleExists(scheduleNo, partNo);
                }
            } catch (error) {
                console.log('Lookup error:', error);
                alertDiv.style.display = 'none';
            }
        }
        
        async function checkScheduleExists(scheduleNo, partNo) {
            // Check Schedule Tracker to get batch qty even if station is different
            const sheetUrl = localStorage.getItem('googleSheetsUrl');
            if (!sheetUrl) return;
            
            try {
                const queryUrl = `${sheetUrl}?action=getScheduleInfo&scheduleNo=${encodeURIComponent(scheduleNo)}&partNo=${encodeURIComponent(partNo)}`;
                const response = await fetch(queryUrl);
                const data = await response.json();
                
                if (data.exists && data.batchQty) {
                    const batchQtyInput = document.getElementById('batch-qty');
                    if (!batchQtyInput.value) {
                        batchQtyInput.value = data.batchQty;
                        batchQtyInput.readOnly = true;
                    }
                }
            } catch (error) {
                console.log('Schedule check error:', error);
            }
        }

        function proceedToInspection() {
            const partNo = document.getElementById('part-no').value.trim();
            const scheduleNo = document.getElementById('schedule-no').value.trim();
            const batchQty = parseInt(document.getElementById('batch-qty').value) || 0;
            const station = document.getElementById('station').value;
            const substation = document.getElementById('substation').value.trim();
            const operatorName = document.getElementById('operator-name').value.trim();
            const inspectorName = document.getElementById('inspector-name').value.trim();

            if (!partNo || !scheduleNo || !batchQty || !station || !inspectorName) {
                alert('Please fill in all required fields (marked with *)');
                return;
            }

            const selectedCheckboxes = document.querySelectorAll('#check-codes input[type="checkbox"]:checked');
            if (selectedCheckboxes.length === 0) {
                alert('Please select at least one check code');
                return;
            }

            // Calculate sample size if not already done
            if (!currentSchedule.sampleSize) {
                const result = calculateSampleSize(batchQty);
                currentSchedule.sampleSize = result.sampleSize;
                currentSchedule.sampleCodeLetter = result.letter;
            }

            currentSchedule.partNo = partNo;
            currentSchedule.scheduleNo = scheduleNo;
            currentSchedule.batchQty = batchQty;
            currentSchedule.station = station;
            currentSchedule.substation = substation;
            currentSchedule.operatorName = operatorName || 'N/A';
            currentSchedule.inspectorName = inspectorName;
            currentSchedule.selectedChecks = [];

            selectedCheckboxes.forEach(cb => {
                const checkId = cb.value;
                const checkData = stationChecks[station].find(c => c.id === checkId);
                currentSchedule.selectedChecks.push(checkData);
            });

            // Use sample size as total checks needed, not batch qty
            if (!currentSchedule.totalChecksNeeded) {
                currentSchedule.totalChecksNeeded = currentSchedule.sampleSize;
            }

            renderBatchProgress();
            renderQualityChecks();
            showScreen('screen-quality-check');
        }

        function renderBatchProgress() {
            const progressDiv = document.getElementById('batch-progress-info');
            const sampleSize = currentSchedule.sampleSize || currentSchedule.totalChecksNeeded;
            const remaining = sampleSize - currentSchedule.checksCompleted;
            
            progressDiv.innerHTML = `
                <h4>Schedule: ${currentSchedule.scheduleNo}</h4>
                <div class="summary-item">
                    <strong>Batch Qty (Production):</strong>
                    <span>${currentSchedule.batchQty}</span>
                </div>
                <div class="summary-item">
                    <strong>Sample Size (Inspect):</strong>
                    <span style="color: #667eea; font-weight: 600;">${sampleSize}${currentSchedule.sampleCodeLetter ? ' (Code ' + currentSchedule.sampleCodeLetter + ')' : ''}</span>
                </div>
                <div class="summary-item">
                    <strong>Samples Inspected:</strong>
                    <span style="color: #10b981; font-weight: 600;">${currentSchedule.checksCompleted}</span>
                </div>
                <div class="summary-item">
                    <strong>Remaining Samples:</strong>
                    <span style="color: #f59e0b; font-weight: 600;">${remaining}</span>
                </div>
            `;
        }

        function renderQualityChecks() {
            const container = document.getElementById('checks-container');
            container.innerHTML = '';
            currentInspection.checkResults = [];
            
            // Set up suggested sample display
            const suggestedSample = currentSchedule.sampleSize || 0;
            const inspectionLevel = currentSchedule.inspectionLevel || '';
            const remaining = currentSchedule.totalChecksNeeded - currentSchedule.checksCompleted;
            
            document.getElementById('remaining-display').textContent = remaining;
            
            if (suggestedSample > 0) {
                document.getElementById('suggested-sample-text').innerHTML = 
                    `üìä Suggested: <strong>${suggestedSample}</strong> (ISO 2859 Level ${inspectionLevel}, Code ${currentSchedule.sampleCodeLetter}). You can check more if needed.`;
            } else {
                document.getElementById('suggested-sample-text').textContent = 
                    'Enter the number of items you want to inspect today.';
            }

            currentSchedule.selectedChecks.forEach((check, index) => {
                const checkDiv = document.createElement('div');
                checkDiv.className = 'check-item';
                checkDiv.id = `check-item-${index}`;
                checkDiv.innerHTML = `
                    <div>
                        <div class="check-id">${check.id}</div>
                        <div style="font-size: 14px; color: #333; font-weight: 600; margin-top: 5px;">${check.check}</div>
                    </div>
                    <div class="check-spec">${check.spec}</div>
                    
                    <div id="results-${index}" style="display: none; margin-top: 15px;">
                        <div style="background: #f0f4ff; padding: 12px; border-radius: 8px; margin: 10px 0; border: 1px solid #667eea;">
                            <p style="font-size: 13px; color: #4338ca; margin-bottom: 8px;"><strong>Quick Select:</strong></p>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                                <button onclick="selectRange(${index}, 'all-pass')" style="padding: 8px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">All Pass ‚úì</button>
                                <button onclick="selectRange(${index}, 'all-fail')" style="padding: 8px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">All Fail ‚úó</button>
                                <button onclick="clearSelection(${index})" style="padding: 8px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">Clear</button>
                            </div>
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #c7d2fe;">
                                <p style="font-size: 12px; color: #4338ca; margin-bottom: 6px;"><strong>Select Range:</strong></p>
                                <div style="display: flex; gap: 6px; align-items: center;">
                                    <input type="number" id="range-from-${index}" placeholder="From" min="1" style="flex: 1; padding: 6px; border: 1px solid #c7d2fe; border-radius: 4px; font-size: 13px;">
                                    <span style="color: #6b7280;">to</span>
                                    <input type="number" id="range-to-${index}" placeholder="To" min="1" style="flex: 1; padding: 6px; border: 1px solid #c7d2fe; border-radius: 4px; font-size: 13px;">
                                    <button onclick="selectRange(${index}, 'pass')" style="padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Pass</button>
                                    <button onclick="selectRange(${index}, 'fail')" style="padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Fail</button>
                                </div>
                            </div>
                            <p style="font-size: 11px; color: #6b7280; margin-top: 8px;">üí° Tip: Hold Shift and click two items to select range</p>
                        </div>
                        <label>Mark Results for ${check.id} (Click or Shift+Click for range):</label>
                        <div class="result-buttons" id="result-buttons-${index}"></div>
                    </div>

                    <div class="fail-section" id="fail-section-${index}">
                        <div id="fail-items-${index}"></div>
                    </div>
                `;
                container.appendChild(checkDiv);

                currentInspection.checkResults.push({
                    checkData: check,
                    checkedQty: 0,
                    results: [],
                    failedItems: []
                });
            });

            updateProgress();
        }

        function updateBatchCheckQty() {
            const qty = parseInt(document.getElementById('batch-check-qty').value) || 0;
            const maxAllowed = currentSchedule.totalChecksNeeded - currentSchedule.checksCompleted;
            
            if (qty > maxAllowed) {
                alert(`You can only check up to ${maxAllowed} items (remaining in batch)`);
                document.getElementById('batch-check-qty').value = maxAllowed;
                return;
            }

            // Update remaining display
            const newRemaining = maxAllowed - qty;
            document.getElementById('remaining-display').textContent = newRemaining >= 0 ? newRemaining : maxAllowed;

            if (qty > 0) {
                // Update all checks with the same quantity
                currentInspection.checkResults.forEach((result, index) => {
                    result.checkedQty = qty;
                    
                    // Show result buttons for each check
                    const resultsDiv = document.getElementById(`results-${index}`);
                    const buttonsDiv = document.getElementById(`result-buttons-${index}`);
                    
                    resultsDiv.style.display = 'block';
                    buttonsDiv.innerHTML = '';
                    
                    for (let i = 0; i < qty; i++) {
                        const btn = document.createElement('button');
                        btn.className = 'result-btn';
                        btn.textContent = i + 1;
                        btn.onclick = function(e) {
                            toggleResult(index, i, e.shiftKey);
                        };
                        buttonsDiv.appendChild(btn);
                    }

                    result.results = new Array(qty).fill('pending');
                    lastClickedButton[index] = null;
                    
                    document.getElementById(`range-from-${index}`).max = qty;
                    document.getElementById(`range-to-${index}`).max = qty;
                });
            } else {
                // Hide all result sections
                currentInspection.checkResults.forEach((result, index) => {
                    document.getElementById(`results-${index}`).style.display = 'none';
                });
            }
            
            updateProgress();
        }

        function updateCheckLevel(checkIndex) {
            // This function is no longer needed for per-check level
            // Level is set globally at the schedule level
        }

        function toggleResult(checkIndex, itemIndex, shiftKey) {
            const btn = document.getElementById(`result-buttons-${checkIndex}`).children[itemIndex];
            
            if (shiftKey && lastClickedButton[checkIndex] !== null && lastClickedButton[checkIndex] !== itemIndex) {
                const start = Math.min(lastClickedButton[checkIndex], itemIndex);
                const end = Math.max(lastClickedButton[checkIndex], itemIndex);
                const firstState = currentInspection.checkResults[checkIndex].results[lastClickedButton[checkIndex]];
                
                for (let i = start; i <= end; i++) {
                    const rangeBtn = document.getElementById(`result-buttons-${checkIndex}`).children[i];
                    if (firstState === 'pending') {
                        currentInspection.checkResults[checkIndex].results[i] = 'pass';
                        rangeBtn.classList.add('pass');
                        rangeBtn.classList.remove('fail');
                    } else {
                        currentInspection.checkResults[checkIndex].results[i] = firstState;
                        if (firstState === 'pass') {
                            rangeBtn.classList.add('pass');
                            rangeBtn.classList.remove('fail');
                        } else {
                            rangeBtn.classList.add('fail');
                            rangeBtn.classList.remove('pass');
                        }
                    }
                }
            } else {
                const currentResult = currentInspection.checkResults[checkIndex].results[itemIndex];
                
                if (currentResult === 'pending') {
                    currentInspection.checkResults[checkIndex].results[itemIndex] = 'pass';
                    btn.classList.add('pass');
                    btn.classList.remove('fail');
                } else if (currentResult === 'pass') {
                    currentInspection.checkResults[checkIndex].results[itemIndex] = 'fail';
                    btn.classList.remove('pass');
                    btn.classList.add('fail');
                } else {
                    currentInspection.checkResults[checkIndex].results[itemIndex] = 'pending';
                    btn.classList.remove('pass', 'fail');
                }
            }
            
            lastClickedButton[checkIndex] = itemIndex;
            updateFailItems(checkIndex);
            updateProgress();
        }

        function selectRange(checkIndex, action) {
            const buttonsDiv = document.getElementById(`result-buttons-${checkIndex}`);
            const buttons = buttonsDiv.children;
            
            if (action === 'all-pass') {
                for (let i = 0; i < buttons.length; i++) {
                    currentInspection.checkResults[checkIndex].results[i] = 'pass';
                    buttons[i].classList.add('pass');
                    buttons[i].classList.remove('fail');
                }
            } else if (action === 'all-fail') {
                for (let i = 0; i < buttons.length; i++) {
                    currentInspection.checkResults[checkIndex].results[i] = 'fail';
                    buttons[i].classList.add('fail');
                    buttons[i].classList.remove('pass');
                }
            } else if (action === 'pass' || action === 'fail') {
                const from = parseInt(document.getElementById(`range-from-${checkIndex}`).value) || 1;
                const to = parseInt(document.getElementById(`range-to-${checkIndex}`).value) || buttons.length;
                
                if (from < 1 || to > buttons.length || from > to) {
                    alert('Invalid range!');
                    return;
                }
                
                for (let i = from - 1; i < to; i++) {
                    currentInspection.checkResults[checkIndex].results[i] = action;
                    if (action === 'pass') {
                        buttons[i].classList.add('pass');
                        buttons[i].classList.remove('fail');
                    } else {
                        buttons[i].classList.add('fail');
                        buttons[i].classList.remove('pass');
                    }
                }
            }
            
            updateFailItems(checkIndex);
            updateProgress();
        }

        function clearSelection(checkIndex) {
            const buttonsDiv = document.getElementById(`result-buttons-${checkIndex}`);
            const buttons = buttonsDiv.children;
            
            for (let i = 0; i < buttons.length; i++) {
                currentInspection.checkResults[checkIndex].results[i] = 'pending';
                buttons[i].classList.remove('pass', 'fail');
            }
            
            updateFailItems(checkIndex);
            updateProgress();
        }

        function updateFailItems(checkIndex) {
            const results = currentInspection.checkResults[checkIndex].results;
            const failIndices = [];
            
            results.forEach((result, idx) => {
                if (result === 'fail') {
                    failIndices.push(idx);
                }
            });

            const failSection = document.getElementById(`fail-section-${checkIndex}`);
            const failItemsDiv = document.getElementById(`fail-items-${checkIndex}`);
            
            if (failIndices.length > 0) {
                failSection.classList.add('active');
                
                failItemsDiv.innerHTML = '<label style="font-weight: 600; color: #ef4444; margin-bottom: 10px; display: block;">Failed Items: ' + failIndices.length + '</label>';
                failIndices.forEach(failIdx => {
                    const itemDiv = document.createElement('div');
                    itemDiv.style.cssText = 'background: white; padding: 15px; border-radius: 8px; margin: 10px 0; border: 2px solid #ef4444;';
                    itemDiv.innerHTML = `
                        <h4 style="color: #ef4444; margin-bottom: 10px;">Failed Item #${failIdx + 1}</h4>
                        <div class="form-group">
                            <label>Failure Description:</label>
                            <textarea id="fail-desc-${checkIndex}-${failIdx}" rows="2" placeholder="Describe the failure..." style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Upload Photo (Optional):</label>
                            <input type="file" id="fail-photo-${checkIndex}-${failIdx}" accept="image/*" capture="environment" onchange="previewFailPhoto(${checkIndex}, ${failIdx})">
                            <img id="photo-preview-${checkIndex}-${failIdx}" class="photo-preview" style="display: none;">
                        </div>
                    `;
                    failItemsDiv.appendChild(itemDiv);
                });
            } else {
                failSection.classList.remove('active');
                failItemsDiv.innerHTML = '';
            }
        }

        function previewFailPhoto(checkIndex, failIndex) {
            const input = document.getElementById(`fail-photo-${checkIndex}-${failIndex}`);
            const preview = document.getElementById(`photo-preview-${checkIndex}-${failIndex}`);
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function updateProgress() {
            let completed = 0;
            const total = currentInspection.checkResults.length;

            currentInspection.checkResults.forEach((result, index) => {
                const qtyEntered = result.checkedQty > 0;
                const allMarked = result.results.length > 0 && 
                                 result.results.length === result.checkedQty &&
                                 result.results.every(r => r !== 'pending');
                
                if (qtyEntered && allMarked) {
                    completed++;
                    document.getElementById(`check-item-${index}`).classList.add('completed');
                } else {
                    document.getElementById(`check-item-${index}`).classList.remove('completed');
                }
            });

            const percentage = total > 0 ? (completed / total) * 100 : 0;
            document.getElementById('progress-fill').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = `${completed} of ${total} completed`;

            const submitBtn = document.getElementById('submit-btn');
            if (completed === total && total > 0) {
                submitBtn.style.display = 'block';
            } else {
                submitBtn.style.display = 'none';
            }
        }

        async function submitInspection() {
            const submitBtn = document.getElementById('submit-btn');
            if (submitBtn.disabled) return;
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Submitting...';
            
            // Get the batch check qty (same for all checks)
            const totalCheckedToday = parseInt(document.getElementById('batch-check-qty').value) || 0;

            currentInspection.checkResults.forEach((result, checkIndex) => {
                const failedItems = [];
                result.results.forEach((res, itemIdx) => {
                    if (res === 'fail') {
                        const descInput = document.getElementById(`fail-desc-${checkIndex}-${itemIdx}`);
                        const photoPreview = document.getElementById(`photo-preview-${checkIndex}-${itemIdx}`);
                        
                        failedItems.push({
                            itemNumber: itemIdx + 1,
                            description: descInput ? descInput.value : '',
                            photo: photoPreview ? photoPreview.src : null
                        });
                    }
                });
                result.failedItems = failedItems;
            });

            const sheetData = {
                scheduleNo: currentSchedule.scheduleNo,
                partNo: currentSchedule.partNo,
                batchQty: currentSchedule.batchQty,
                sampleSize: currentSchedule.sampleSize || currentSchedule.batchQty,
                operatorName: currentSchedule.operatorName,
                inspectorName: currentSchedule.inspectorName,
                station: currentSchedule.station,
                substation: currentSchedule.substation,
                inspectionLevel: currentSchedule.inspectionLevel || '',
                previouslyCompleted: currentSchedule.checksCompleted,
                checkedToday: totalCheckedToday,
                checks: currentInspection.checkResults.map(result => ({
                    id: result.checkData.id,
                    check: result.checkData.check,
                    specification: result.checkData.spec,
                    checkedQty: result.checkedQty,
                    pass: result.results.filter(r => r === 'pass').length,
                    fail: result.results.filter(r => r === 'fail').length,
                    results: result.results, // Individual sample results: ['pass', 'fail', 'pass', ...]
                    failedItems: result.failedItems || []
                }))
            };

            const sheetUrl = localStorage.getItem('googleSheetsUrl');
            
            let inspectionId = 'INS-' + new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            let submissionSuccess = false;
            
            try {
                submitBtn.textContent = 'üì§ Sending to Google Sheets...';
                
                const response = await fetch(sheetUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify(sheetData),
                    redirect: 'follow',
                    mode: 'no-cors'
                });
                
                // With no-cors, we can't read response, but if no error thrown, it sent
                submissionSuccess = true;
                submitBtn.textContent = '‚úì Data Sent!';
                
            } catch (error) {
                console.log('Fetch error:', error);
                submitBtn.textContent = '‚ö†Ô∏è May Have Failed';
                submissionSuccess = false;
            }
            
            // Wait a moment so user sees the status
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Always proceed to success screen
            displaySummary(totalCheckedToday, inspectionId, submissionSuccess);
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Inspection';
            showScreen('screen-success');
            
            // Auto-redirect to home after 3 seconds
            setTimeout(() => {
                goToStart();
            }, 3000);
        }

        function displaySummary(totalCheckedToday, inspectionId, submissionSuccess) {
            let totalPass = 0;
            let totalFail = 0;

            currentInspection.checkResults.forEach(result => {
                totalPass += result.results.filter(r => r === 'pass').length;
                totalFail += result.results.filter(r => r === 'fail').length;
            });

            const newTotal = currentSchedule.checksCompleted + totalCheckedToday;
            const remaining = currentSchedule.sampleSize - newTotal;
            const isComplete = remaining === 0;

            document.getElementById('success-message').innerHTML = `
                Checked ${totalCheckedToday} items today at <strong>${currentSchedule.station}</strong>.<br>
                ${isComplete ? '<strong style="color: #10b981;">‚úì This station is complete!</strong>' : `<strong>${remaining} items remaining at this station.</strong>`}
            `;
            
            // Show submission status
            const statusDiv = document.getElementById('submission-status');
            if (submissionSuccess) {
                statusDiv.style.background = '#d1fae5';
                statusDiv.style.color = '#065f46';
                statusDiv.style.border = '2px solid #10b981';
                statusDiv.innerHTML = '‚úÖ Data successfully saved to Google Sheets!';
            } else {
                statusDiv.style.background = '#fee2e2';
                statusDiv.style.color = '#991b1b';
                statusDiv.style.border = '2px solid #ef4444';
                statusDiv.innerHTML = '‚ö†Ô∏è Unable to confirm submission. Please check Google Sheets.';
            }
            
            // Pre-fill current schedule for PDF download
            document.getElementById('pdf-schedule-no').value = currentSchedule.scheduleNo;
            document.getElementById('current-schedule-display').textContent = currentSchedule.scheduleNo;

            document.getElementById('inspection-summary').innerHTML = `
                <h3 style="margin-bottom: 15px;">Inspection Summary</h3>
                <div class="summary-item">
                    <strong>Schedule No:</strong>
                    <span>${currentSchedule.scheduleNo}</span>
                </div>
                <div class="summary-item">
                    <strong>Part No:</strong>
                    <span>${currentSchedule.partNo}</span>
                </div>
                <div class="summary-item">
                    <strong>Station:</strong>
                    <span>${currentSchedule.station}</span>
                </div>
                <div class="summary-item">
                    <strong>Batch Qty:</strong>
                    <span>${currentSchedule.batchQty.toLocaleString()}</span>
                </div>
                <div class="summary-item">
                    <strong>Sample Size (this station):</strong>
                    <span style="color: #667eea; font-weight: 600;">${currentSchedule.sampleSize}${currentSchedule.sampleCodeLetter ? ' (Code ' + currentSchedule.sampleCodeLetter + ')' : ''}</span>
                </div>
                <div class="summary-item">
                    <strong>Inspected Today:</strong>
                    <span style="color: #667eea; font-weight: 600;">${totalCheckedToday}</span>
                </div>
                <div class="summary-item">
                    <strong>Total at Station:</strong>
                    <span style="color: #10b981; font-weight: 600;">${newTotal}</span>
                </div>
                <div class="summary-item">
                    <strong>Remaining:</strong>
                    <span style="color: #f59e0b; font-weight: 600;">${remaining}</span>
                </div>
                <hr style="margin: 15px 0; border: none; border-top: 1px solid #e5e7eb;">
                <div class="summary-item">
                    <strong>Passed Today:</strong>
                    <span style="color: #10b981; font-weight: 600;">${totalPass}</span>
                </div>
                <div class="summary-item">
                    <strong>Failed Today:</strong>
                    <span style="color: #ef4444; font-weight: 600;">${totalFail}</span>
                </div>
            `;
        }

        function showDownloadControlSheet() {
            showScreen('screen-download-control');
            document.getElementById('download-schedule-no').focus();
        }
        
        async function downloadSchedulePDF() {
            const scheduleNo = document.getElementById('download-schedule-no').value.trim();
            const statusDiv = document.getElementById('download-status');
            
            if (!scheduleNo) {
                statusDiv.innerHTML = '<div class="alert alert-warning">Please enter a schedule number</div>';
                return;
            }
            
            const sheetUrl = localStorage.getItem('googleSheetsUrl');
            if (!sheetUrl) {
                statusDiv.innerHTML = '<div class="alert alert-warning">Google Sheets URL not configured. Please check settings.</div>';
                return;
            }
            
            try {
                statusDiv.innerHTML = '<div class="alert alert-info">‚è≥ Generating PDF for schedule ' + scheduleNo + '...</div>';
                
                // Request PDF generation
                const queryUrl = `${sheetUrl}?action=generatePDF&scheduleNo=${encodeURIComponent(scheduleNo)}`;
                const response = await fetch(queryUrl);
                const data = await response.json();
                
                if (data.pdfUrl) {
                    statusDiv.innerHTML = '<div class="alert alert-success">‚úì PDF Generated Successfully!<br><br><a href="' + data.pdfUrl + '" target="_blank" class="btn btn-primary" style="margin: 10px 0;">üì• Open PDF</a></div>';
                    // Also open automatically
                    window.open(data.pdfUrl, '_blank');
                } else if (data.error) {
                    statusDiv.innerHTML = '<div class="alert alert-warning">Error: ' + data.error + '</div>';
                } else {
                    statusDiv.innerHTML = '<div class="alert alert-warning">Schedule "' + scheduleNo + '" not found in control sheets.<br><br>Make sure you\'ve completed at least one inspection for this schedule.</div>';
                }
            } catch (error) {
                console.log('PDF generation error:', error);
                statusDiv.innerHTML = '<div class="alert alert-warning">Failed to generate PDF. Please check your internet connection and try again.</div>';
            }
        }
        
        async function downloadControlSheetPDF() {
            const scheduleNo = document.getElementById('pdf-schedule-no').value.trim();
            
            if (!scheduleNo) {
                alert('Please enter a schedule number');
                return;
            }
            
            const sheetUrl = localStorage.getItem('googleSheetsUrl');
            if (!sheetUrl) {
                alert('Google Sheets URL not configured');
                return;
            }
            
            try {
                // Show loading
                const btn = event.target;
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.textContent = '‚è≥ Generating PDF...';
                
                // Request PDF generation
                const queryUrl = `${sheetUrl}?action=generatePDF&scheduleNo=${encodeURIComponent(scheduleNo)}`;
                const response = await fetch(queryUrl);
                const data = await response.json();
                
                if (data.pdfUrl) {
                    // Open PDF in new tab
                    window.open(data.pdfUrl, '_blank');
                    btn.textContent = '‚úì PDF Downloaded!';
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }, 2000);
                } else if (data.error) {
                    alert('Error: ' + data.error);
                    btn.disabled = false;
                    btn.textContent = originalText;
                } else {
                    alert('Schedule not found. Please check the schedule number.');
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            } catch (error) {
                console.log('PDF generation error:', error);
                alert('Failed to generate PDF. Please try downloading from Google Sheets directly.');
                event.target.disabled = false;
                event.target.textContent = 'üì• Download PDF';
            }
        }
        
        function startNewInspection() {
            goToStart();
        }
        
        function openControlSheet() {
            const sheetUrl = localStorage.getItem('googleSheetsUrl');
            if (sheetUrl) {
                // Extract spreadsheet ID from the web app URL
                const spreadsheetId = sheetUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/)?.[1];
                if (spreadsheetId) {
                    // Open the Control Sheets tab directly
                    window.open(`https://docs.google.com/spreadsheets/d/${spreadsheetId}/edit#gid=0`, '_blank');
                } else {
                    alert('Please open your Google Spreadsheet and go to the "Control Sheets" tab.');
                }
            } else {
                alert('Google Sheets URL not configured. Please check settings.');
            }
        }

        // Settings functions
        function showSettingsModal() {
            document.getElementById('settings-modal').classList.add('active');
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.remove('active');
            document.getElementById('admin-password').value = '';
            document.getElementById('settings-content').style.display = 'none';
            document.getElementById('check-password-btn').style.display = 'block';
        }

        function checkPassword() {
            const password = document.getElementById('admin-password').value;
            if (password === ADMIN_PASSWORD) {
                document.getElementById('settings-content').style.display = 'block';
                document.getElementById('check-password-btn').style.display = 'none';
                
                const currentUrl = localStorage.getItem('googleSheetsUrl');
                if (currentUrl) {
                    document.getElementById('sheet-url-input').value = currentUrl;
                }
            } else {
                alert('Incorrect password!');
            }
        }

        function saveSettings() {
            const url = document.getElementById('sheet-url-input').value.trim();
            if (!url) {
                alert('Please enter the Web App URL');
                return;
            }
            if (!url.includes('script.google.com')) {
                alert('Please enter a valid Google Apps Script URL');
                return;
            }
            localStorage.setItem('googleSheetsUrl', url);
            alert('Settings saved successfully!');
            closeSettingsModal();
            checkConfiguration();
        }
    </script>
</body>
</html>