getElementById('batch-check-qty').value) || 0;
            const maxAllowed = currentSchedule.totalChecksNeeded - currentSchedule.checksCompleted;
            
            if (qty > maxAllowed) {
                alert(`You can only check up to ${maxAllowed} items (remaining in batch)`);
                document.getElementById('batch-check-qty').value = maxAllowed;
                return;
            }

            const newRemaining = maxAllowed - qty;
            document.getElementById('remaining-display').textContent = newRemaining >= 0 ? newRemaining : maxAllowed;

            if (qty > 0) {
                currentInspection.checkResults.forEach((result, index) => {
                    result.checkedQty = qty;
                    
                    const resultsDiv = document.getElementById(`results-${index}`);
                    const buttonsDiv = document.getElementById(`result-buttons-${index}`);
                    
                    resultsDiv.style.display = 'block';
                    buttonsDiv.innerHTML = '';
                    
                    for (let i = 0; i < qty; i++) {
                        const btn = document.createElement('button');
                        btn.className = 'result-btn';
                        btn.textContent = i + 1;
                        btn.onclick = function(e) {
                            toggleResult(index, i, e.shiftKey);
                        };
                        buttonsDiv.appendChild(btn);
                    }

                    result.results = new Array(qty).fill('pending');
                    lastClickedButton[index] = null;
                    
                    document.getElementById(`range-from-${index}`).max = qty;
                    document.getElementById(`range-to-${index}`).max = qty;
                });
            } else {
                currentInspection.checkResults.forEach((result, index) => {
                    document.getElementById(`results-${index}`).style.display = 'none';
                });
            }
            
            updateProgress();
        }

        function toggleResult(checkIndex, itemIndex, shiftKey) {
            const btn = document.getElementById(`result-buttons-${checkIndex}`).children[itemIndex];
            
            if (shiftKey && lastClickedButton[checkIndex] !== null && lastClickedButton[checkIndex] !== itemIndex) {
                const start = Math.min(lastClickedButton[checkIndex], itemIndex);
                const end = Math.max(lastClickedButton[checkIndex], itemIndex);
                const firstState = currentInspection.checkResults[checkIndex].results[lastClickedButton[checkIndex]];
                
                for (let i = start; i <= end; i++) {
                    const rangeBtn = document.getElementById(`result-buttons-${checkIndex}`).children[i];
                    if (firstState === 'pending') {
                        currentInspection.checkResults[checkIndex].results[i] = 'pass';
                        rangeBtn.classList.add('pass');
                        rangeBtn.classList.remove('fail');
                    } else {
                        currentInspection.checkResults[checkIndex].results[i] = firstState;
                        if (firstState === 'pass') {
                            rangeBtn.classList.add('pass');
                            rangeBtn.classList.remove('fail');
                        } else {
                            rangeBtn.classList.add('fail');
                            rangeBtn.classList.remove('pass');
                        }
                    }
                }
            } else {
                const currentResult = currentInspection.checkResults[checkIndex].results[itemIndex];
                
                if (currentResult === 'pending') {
                    currentInspection.checkResults[checkIndex].results[itemIndex] = 'pass';
                    btn.classList.add('pass');
                    btn.classList.remove('fail');
                } else if (currentResult === 'pass') {
                    currentInspection.checkResults[checkIndex].results[itemIndex] = 'fail';
                    btn.classList.remove('pass');
                    btn.classList.add('fail');
                } else {
                    currentInspection.checkResults[checkIndex].results[itemIndex] = 'pending';
                    btn.classList.remove('pass', 'fail');
                }
            }
            
            lastClickedButton[checkIndex] = itemIndex;
            updateFailItems(checkIndex);
            updateProgress();
        }

        function selectRange(checkIndex, action) {
            const buttonsDiv = document.getElementById(`result-buttons-${checkIndex}`);
            const buttons = buttonsDiv.children;
            
            if (action === 'all-pass') {
                for (let i = 0; i < buttons.length; i++) {
                    currentInspection.checkResults[checkIndex].results[i] = 'pass';
                    buttons[i].classList.add('pass');
                    buttons[i].classList.remove('fail');
                }
            } else if (action === 'all-fail') {
                for (let i = 0; i < buttons.length; i++) {
                    currentInspection.checkResults[checkIndex].results[i] = 'fail';
                    buttons[i].classList.add('fail');
                    buttons[i].classList.remove('pass');
                }
            } else if (action === 'pass' || action === 'fail') {
                const from = parseInt(document.getElementById(`range-from-${checkIndex}`).value) || 1;
                const to = parseInt(document.getElementById(`range-to-${checkIndex}`).value) || buttons.length;
                
                if (from < 1 || to > buttons.length || from > to) {
                    alert('Invalid range!');
                    return;
                }
                
                for (let i = from - 1; i < to; i++) {
                    currentInspection.checkResults[checkIndex].results[i] = action;
                    if (action === 'pass') {
                        buttons[i].classList.add('pass');
                        buttons[i].classList.remove('fail');
                    } else {
                        buttons[i].classList.add('fail');
                        buttons[i].classList.remove('pass');
                    }
                }
            }
            
            updateFailItems(checkIndex);
            updateProgress();
        }

        function clearSelection(checkIndex) {
            const buttonsDiv = document.getElementById(`result-buttons-${checkIndex}`);
            const buttons = buttonsDiv.children;
            
            for (let i = 0; i < buttons.length; i++) {
                currentInspection.checkResults[checkIndex].results[i] = 'pending';
                buttons[i].classList.remove('pass', 'fail');
            }
            
            updateFailItems(checkIndex);
            updateProgress();
        }

        function updateFailItems(checkIndex) {
            const results = currentInspection.checkResults[checkIndex].results;
            const failIndices = [];
            
            results.forEach((result, idx) => {
                if (result === 'fail') {
                    failIndices.push(idx);
                }
            });

            const failSection = document.getElementById(`fail-section-${checkIndex}`);
            const failItemsDiv = document.getElementById(`fail-items-${checkIndex}`);
            
            if (failIndices.length > 0) {
                failSection.classList.add('active');
                
                failItemsDiv.innerHTML = '<label style="font-weight: 600; color: #ef4444; margin-bottom: 10px; display: block;">Failed Items: ' + failIndices.length + '</label>';
                failIndices.forEach(failIdx => {
                    const itemDiv = document.createElement('div');
                    itemDiv.style.cssText = 'background: white; padding: 15px; border-radius: 8px; margin: 10px 0; border: 2px solid #ef4444;';
                    itemDiv.innerHTML = `
                        <h4 style="color: #ef4444; margin-bottom: 10px;">Failed Item #${failIdx + 1}</h4>
                        <div class="form-group">
                            <label>Failure Description:</label>
                            <textarea id="fail-desc-${checkIndex}-${failIdx}" rows="2" placeholder="Describe the failure..." style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Upload Photo (Optional):</label>
                            <input type="file" id="fail-photo-${checkIndex}-${failIdx}" accept="image/*" capture="environment" onchange="previewFailPhoto(${checkIndex}, ${failIdx})">
                            <img id="photo-preview-${checkIndex}-${failIdx}" class="photo-preview" style="display: none;">
                        </div>
                    `;
                    failItemsDiv.appendChild(itemDiv);
                });
            } else {
                failSection.classList.remove('active');
                failItemsDiv.innerHTML = '';
            }
        }

        function previewFailPhoto(checkIndex, failIndex) {
            const input = document.getElementById(`fail-photo-${checkIndex}-${failIndex}`);
            const preview = document.getElementById(`photo-preview-${checkIndex}-${failIndex}`);
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function updateProgress() {
            let completed = 0;
            const total = currentInspection.checkResults.length;

            currentInspection.checkResults.forEach((result, index) => {
                const qtyEntered = result.checkedQty > 0;
                const allMarked = result.results.length > 0 && 
                                 result.results.length === result.checkedQty &&
                                 result.results.every(r => r !== 'pending');
                
                if (qtyEntered && allMarked) {
                    completed++;
                    document.getElementById(`check-item-${index}`).classList.add('completed');
                } else {
                    document.getElementById(`check-item-${index}`).classList.remove('completed');
                }
            });

            const percentage = total > 0 ? (completed / total) * 100 : 0;
            document.getElementById('progress-fill').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = `${completed} of ${total} completed`;

            const submitBtn = document.getElementById('submit-btn');
            if (completed === total && total > 0) {
                submitBtn.style.display = 'block';
            } else {
                submitBtn.style.display = 'none';
            }
        }

        async function submitInspection() {
            const submitBtn = document.getElementById('submit-btn');
            if (submitBtn.disabled) return;
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Submitting...';
            
            const totalCheckedToday = parseInt(document.getElementById('batch-check-qty').value) || 0;

            currentInspection.checkResults.forEach((result, checkIndex) => {
                const failedItems = [];
                result.results.forEach((res, itemIdx) => {
                    if (res === 'fail') {
                        const descInput = document.getElementById(`fail-desc-${checkIndex}-${itemIdx}`);
                        const photoPreview = document.getElementById(`photo-preview-${checkIndex}-${itemIdx}`);
                        
                        failedItems.push({
                            itemNumber: itemIdx + 1,
                            description: descInput ? descInput.value : '',
                            photo: photoPreview ? photoPreview.src : null
                        });
                    }
                });
                result.failedItems = failedItems;
            });

            const sheetData = {
                scheduleNo: currentSchedule.scheduleNo,
                partNo: currentSchedule.partNo,
                batchQty: currentSchedule.batchQty,
                sampleSize: currentSchedule.sampleSize || currentSchedule.batchQty,
                operatorName: currentSchedule.operatorName,
                inspectorName: currentSchedule.inspectorName,
                station: currentSchedule.station,
                substation: currentSchedule.substation,
                inspectionLevel: currentSchedule.inspectionLevel || '',
                previouslyCompleted: currentSchedule.checksCompleted,
                checkedToday: totalCheckedToday,
                checks: currentInspection.checkResults.map(result => ({
                    id: result.checkData.id,
                    check: result.checkData.check,
                    specification: result.checkData.spec,
                    checkedQty: result.checkedQty,
                    pass: result.results.filter(r => r === 'pass').length,
                    fail: result.results.filter(r => r === 'fail').length,
                    results: result.results,
                    failedItems: result.failedItems || []
                }))
            };

            const sheetUrl = localStorage.getItem('googleSheetsUrl');
            
            let inspectionId = 'INS-' + new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            let submissionSuccess = false;
            
            try {
                submitBtn.textContent = 'üì§ Sending to Google Sheets...';
                
                const response = await fetch(sheetUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify(sheetData),
                    redirect: 'follow',
                    mode: 'no-cors'
                });
                
                submissionSuccess = true;
                submitBtn.textContent = '‚úì Data Sent!';
                
            } catch (error) {
                console.log('Fetch error:', error);
                submitBtn.textContent = '‚ö†Ô∏è May Have Failed';
                submissionSuccess = false;
            }
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            displaySummary(totalCheckedToday, inspectionId, submissionSuccess);
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Inspection';
            showScreen('screen-success');
        }

        function displaySummary(totalCheckedToday, inspectionId, submissionSuccess) {
            let totalPass = 0;
            let totalFail = 0;

            currentInspection.checkResults.forEach(result => {
                totalPass += result.results.filter(r => r === 'pass').length;
                totalFail += result.results.filter(r => r === 'fail').length;
            });

            const newTotal = currentSchedule.checksCompleted + totalCheckedToday;
            const remaining = currentSchedule.sampleSize - newTotal;
            const isComplete = remaining === 0;

            document.getElementById('success-message').innerHTML = `
                Checked ${totalCheckedToday} items today at <strong>${currentSchedule.station}</strong>.<br>
                ${isComplete ? '<strong style="color: #10b981;">‚úì This station is complete!</strong>' : `<strong>${remaining} items remaining at this station.</strong>`}
            `;
            
            const statusDiv = document.getElementById('submission-status');
            if (submissionSuccess) {
                statusDiv.style.background = '#d1fae5';
                statusDiv.style.color = '#065f46';
                statusDiv.style.border = '2px solid #10b981';
                statusDiv.innerHTML = '‚úÖ Data successfully saved to Google Sheets!';
            } else {
                statusDiv.style.background = '#fee2e2';
                statusDiv.style.color = '#991b1b';
                statusDiv.style.border = '2px solid #ef4444';
                statusDiv.innerHTML = '‚ö†Ô∏è Unable to confirm submission. Please check Google Sheets.';
            }
            
            document.getElementById('pdf-schedule-no').value = currentSchedule.scheduleNo;
            document.getElementById('current-schedule-display').textContent = currentSchedule.scheduleNo;

            document.getElementById('inspection-summary').innerHTML = `
                <h3 style="margin-bottom: 15px;">Inspection Summary</h3>
                <div class="summary-item">
                    <strong>Schedule No:</strong>
                    <span>${currentSchedule.scheduleNo}</span>
                </div>
                <div class="summary-item">
                    <strong>Part No:</strong>
                    <span>${currentSchedule.partNo}</span>
                </div>
                <div class="summary-item">
                    <strong>Station:</strong>
                    <span>${currentSchedule.station}</span>
                </div>
                <div class="summary-item">
                    <strong>Batch Qty:</strong>
                    <span>${currentSchedule.batchQty.toLocaleString()}</span>
                </div>
                <div class="summary-item">
                    <strong>Sample Size (this station):</strong>
                    <span style="color: #667eea; font-weight: 600;">${currentSchedule.sampleSize}${currentSchedule.sampleCodeLetter ? ' (Code ' + currentSchedule.sampleCodeLetter + ')' : ''}</span>
                </div>
                <div class="summary-item">
                    <strong>Inspected Today:</strong>
                    <span style="color: #667eea; font-weight: 600;">${totalCheckedToday}</span>
                </div>
                <div class="summary-item">
                    <strong>Total at Station:</strong>
                    <span style="color: #10b981; font-weight: 600;">${newTotal}</span>
                </div>
                <div class="summary-item">
                    <strong>Remaining:</strong>
                    <span style="color: #f59e0b; font-weight: 600;">${remaining}</span>
                </div>
                <hr style="margin: 15px 0; border: none; border-top: 1px solid #e5e7eb;">
                <div class="summary-item">
                    <strong>Passed Today:</strong>
                    <span style="color: #10b981; font-weight: 600;">${totalPass}</span>
                </div>
                <div class="summary-item">
                    <strong>Failed Today:</strong>
                    <span style="color: #ef4444; font-weight: 600;">${totalFail}</span>
                </div>
            `;
        }

        function showDownloadControlSheet() {
            showScreen('screen-download-control');
            document.getElementById('download-schedule-no').focus();
        }
        
        async function downloadSchedulePDF() {
            const scheduleNo = document.getElementById('download-schedule-no').value.trim();
            const statusDiv = document.getElementById('download-status');
            
            if (!scheduleNo) {
                statusDiv.innerHTML = '<div class="alert alert-warning">Please enter a schedule number</div>';
                return;
            }
            
            const sheetUrl = localStorage.getItem('googleSheetsUrl');
            if (!sheetUrl) {
                statusDiv.innerHTML = '<div class="alert alert-warning">Google Sheets URL not configured. Please check settings.</div>';
                return;
            }
            
            try {
                statusDiv.innerHTML = '<div class="alert alert-info">‚è≥ Generating PDF for schedule ' + scheduleNo + '...</div>';
                
                const queryUrl = `${sheetUrl}?action=generatePDF&scheduleNo=${encodeURIComponent(scheduleNo)}`;
                const response = await fetch(queryUrl);
                const data = await response.json();
                
                if (data.pdfUrl) {
                    statusDiv.innerHTML = '<div class="alert alert-success">‚úì PDF Generated Successfully!<br><br><a href="' + data.pdfUrl + '" target="_blank" class="btn btn-primary" style="margin: 10px 0;">üì• Open PDF</a></div>';
                    window.open(data.pdfUrl, '_blank');
                } else if (data.error) {
                    statusDiv.innerHTML = '<div class="alert alert-warning">Error: ' + data.error + '</div>';
                } else {
                    statusDiv.innerHTML = '<div class="alert alert-warning">Schedule "' + scheduleNo + '" not found in control sheets.<br><br>Make sure you\'ve completed at least one inspection for this schedule.</div>';
                }
            } catch (error) {
                console.log('PDF generation error:', error);
                statusDiv.innerHTML = '<div class="alert alert-warning">Failed to generate PDF. Please check your internet connection and try again.</div>';
            }
        }
        
        async function downloadControlSheetPDF() {
            const scheduleNo = document.getElementById('pdf-schedule-no').value.trim();
            
            if (!scheduleNo) {
                alert('Please enter a schedule number');
                return;
            }
            
            const sheetUrl = localStorage.getItem('googleSheetsUrl');
            if (!sheetUrl) {
                alert('Google Sheets URL not configured');
                return;
            }
            
            try {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.textContent = '‚è≥ Generating PDF...';
                
                const queryUrl = `${sheetUrl}?action=generatePDF&scheduleNo=${encodeURIComponent(scheduleNo)}`;
                const response = await fetch(queryUrl);
                const data = await response.json();
                
                if (data.pdfUrl) {
                    window.open(data.pdfUrl, '_blank');
                    btn.textContent = '‚úì PDF Downloaded!';
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }, 2000);
                } else if (data.error) {
                    alert('Error: ' + data.error);
                    btn.disabled = false;
                    btn.textContent = originalText;
                } else {
                    alert('Schedule not found. Please check the schedule number.');
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            } catch (error) {
                console.log('PDF generation error:', error);
                alert('Failed to generate PDF. Please try downloading from Google Sheets directly.');
                event.target.disabled = false;
                event.target.textContent = 'üì• Download PDF';
            }
        }
        
        function startNewInspection() {
            goToStart();
        }

        // Settings functions
        function showSettingsModal() {
            document.getElementById('settings-modal').classList.add('active');
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.remove('active');
            document.getElementById('admin-password').value = '';
            document.getElementById('settings-content').style.display = 'none';
            document.getElementById('check-password-btn').style.display = 'block';
        }

        function checkPassword() {
            const password = document.getElementById('admin-password').value;
            if (password === ADMIN_PASSWORD) {
                document.getElementById('settings-content').style.display = 'block';
                document.getElementById('check-password-btn').style.display = 'none';
                
                const currentUrl = localStorage.getItem('googleSheetsUrl');
                if (currentUrl) {
                    document.getElementById('sheet-url-input').value = currentUrl;
                }
            } else {
                alert('Incorrect password!');
            }
        }

        function saveSettings() {
            const url = document.getElementById('sheet-url-input').value.trim();
            if (!url) {
                alert('Please enter the Web App URL');
                return;
            }
            if (!url.includes('script.google.com')) {
                alert('Please enter a valid Google Apps Script URL');
                return;
            }
            localStorage.setItem('googleSheetsUrl', url);
            alert('Settings saved successfully!');
            closeSettingsModal();
            checkConfiguration();
        }
    </script>
</body>
</html>
